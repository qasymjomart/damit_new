import torch
import torch.nn as nn
import torch.nn.functional as F
from torch.utils.data import DataLoader, Dataset
import numpy as np
from typing import Tuple, List, Dict, Any
import math

# MONAI imports
from monai.transforms import (
    Compose, LoadImaged, EnsureChannelFirstd, Spacingd, Orientationd,
        ScaleIntensityRanged, RandSpatialCropd, RandRotated, RandZoomd,
            RandGaussianNoised, RandGaussianSmoothd, RandAdjustContrastd,
                RandFlipd, RandAffined, ToTensord, CenterSpatialCropd
                )
from monai.data import CacheDataset
from monai.networks.nets import ViT


class SimCLRAugmentations:
    """SimCLR augmentation pipeline for 3D MRI data using MONAI transforms"""
        
        def __init__(self, 
                crop_size: Tuple[int, int, int] = (96, 96, 96),
                                intensity_range: Tuple[float, float] = (-1, 1)):
                                        
                                                # Base preprocessing transforms
                                                        self.base_transforms = Compose([
                                                                        LoadImaged(keys=["image"]),
                                                                        EnsureChannelFirstd(keys=["image"]),
                                                                        Orientationd(keys=["image"], axcodes="RAS"),
                                                                        Spacingd(keys=["image"], pixdim=(1.0, 1.0, 1.0), mode="bilinear"),
                                                                        ScaleIntensityRanged(keys=["image"], 
                                                                                                                                                        a_min=-1000, a_max=1000,
                                                                                                                                                                                b_min=intensity_range[0], b_max=intensity_range[1],
                                                                                                                                                                                                                clip=True),
                                                                                                                                                                                                                                CenterSpatialCropd(keys=["image"], roi_size=crop_size),
                                                                                                                                                                                                                                        ])
                                                                
                                                                        # Augmentation transforms for SimCLR
                                                                                self.augment_transforms = Compose([
                                                                                                # Spatial augmentations
                                                                                                        RandSpatialCropd(keys=["image"], roi_size=crop_size, random_size=False),
                                                                                                                        RandRotated(keys=["image"], range_x=0.2, range_y=0.2, range_z=0.2, prob=0.8),
                                                                                                                                RandZoomd(keys=["image"], min_zoom=0.8, max_zoom=1.2, prob=0.8),
                                                                                                                                                RandFlipd(keys=["image"], spatial_axis=[0, 1, 2], prob=0.5),
                                                                                                                                                        RandAffined(keys=["image"], 
                                                                                                                                                                                translate_range=(10, 10, 10),
                                                                                                                                                                                                        rotate_range=(0.1, 0.1, 0.1),
                                                                                                                                                                                                                                scale_range=(0.1, 0.1, 0.1),
                                                                                                                                                                                                                                                        prob=0.7),
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                # Intensity augmentations
                                                                                                                                                                                                                                                                                        RandGaussianNoised(keys=["image"], std=0.1, prob=0.6),
                                                                                                                                                                                                                                                                                                        RandGaussianSmoothd(keys=["image"], 
                                                                                                                                                                                                                                                                                                                                sigma_x=(0.5, 1.0), sigma_y=(0.5, 1.0), sigma_z=(0.5, 1.0),
                                                                                                                                                                                                                                                                                                                                                                prob=0.5),
                                                                                                                                                                                                                                                                                                                                                                                RandAdjustContrastd(keys=["image"], gamma=(0.7, 1.3), prob=0.6),
                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                        ToTensord(keys=["image"])
                                                                                                                                                                                                                                                                                                                                                                                                                ])
                                                                                        
                                                                                        def __call__(self, data_dict: Dict[str, Any]) -> Tuple[torch.Tensor, torch.Tensor]:
                                                                                                """Apply base preprocessing and generate two augmented views"""
                                                                                                        # Apply base preprocessing
                                                                                                                processed = self.base_transforms(data_dict)
                                                                                                                        
                                                                                                                                # Generate two different augmented views
                                                                                                                                        view1 = self.augment_transforms(processed.copy())["image"]
                                                                                                                                                view2 = self.augment_transforms(processed.copy())["image"]
                                                                                                                                                                      
                                                                                                                                                                              return view1, view2


                                                                                                                                                                              class ProjectionHead(nn.Module):
                                                                                                                                                                                  """Projection head for SimCLR"""
                                                                                                                                                                                      
                                                                                                                                                                                          def __init__(self, input_dim: int = 768, hidden_dim: int = 512, output_dim: int = 128):
                                                                                                                                                                                                  super().__init__()
                                                                                                                                                                                                          self.projection = nn.Sequential(
                                                                                                                                                                                                                      nn.Linear(input_dim, hidden_dim),
                                                                                                                                                                                                                                  nn.ReLU(),
                                                                                                                                                                                                                                              nn.Linear(hidden_dim, output_dim),
                                                                                                                                                                                                                                                      )
                                                                                                                                                                                                              
                                                                                                                                                                                                                  def forward(self, x: torch.Tensor) -> torch.Tensor:
                                                                                                                                                                                                                          return self.projection(x)


                                                                                                                                                                                                                          class SimCLRViT3D(nn.Module):
                                                                                                                                                                                                                              """SimCLR model with 3D Vision Transformer backbone for MRI data"""
                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                      def __init__(self, 
                                                                                                                                                                                                                                                       img_size: Tuple[int, int, int] = (96, 96, 96),
                                                                                                                                                                                                                                                                        patch_size: Tuple[int, int, int] = (16, 16, 16),
                                                                                                                                                                                                                                                                                         in_channels: int = 1,
                                                                                                                                                                                                                                                                                                          hidden_size: int = 768,
                                                                                                                                                                                                                                                                                                                           mlp_dim: int = 3072,
                                                                                                                                                                                                                                                                                                                                            num_heads: int = 12,
                                                                                                                                                                                                                                                                                                                                                             num_layers: int = 12,
                                                                                                                                                                                                                                                                                                                                                                              projection_dim: int = 128):
                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                              super().__init__()
                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                              # 3D Vision Transformer backbone
                                                                                                                                                                                                                                                                                                                                                                                                                      self.backbone = ViT(
                                                                                                                                                                                                                                                                                                                                                                                                                                  in_channels=in_channels,
                                                                                                                                                                                                                                                                                                                                                                                                                                              img_size=img_size,
                                                                                                                                                                                                                                                                                                                                                                                                                                                          patch_size=patch_size,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      hidden_size=hidden_size,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  mlp_dim=mlp_dim,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              num_heads=num_heads,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          num_layers=num_layers,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      classification=False,  # We'll use the features, not classification
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  dropout_rate=0.1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          )
                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                      # Projection head for contrastive learning
                                                                                                                                                                                                                                                                                                                                                                                                                                              self.projection_head = ProjectionHead(
                                                                                                                                                                                                                                                                                                                                                                                                                                                          input_dim=hidden_size,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      hidden_dim=hidden_size // 2,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  output_dim=projection_dim
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          )
                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                          def forward(self, x: torch.Tensor) -> Tuple[torch.Tensor, torch.Tensor]:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  """Forward pass returning both representations and projections"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          # Get representations from ViT backbone
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  representations = self.backbone(x)[0]  # [batch_size, hidden_size]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  # Apply projection head
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          projections = self.projection_head(representations)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return representations, projections


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          class NTXentLoss(nn.Module):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              """Normalized Temperature-scaled Cross Entropy Loss for SimCLR"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      def __init__(self, temperature: float = 0.07):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              super().__init__()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      self.temperature = temperature
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  def forward(self, z1: torch.Tensor, z2: torch.Tensor) -> torch.Tensor:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  Args:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              z1, z2: Projected representations of shape [batch_size, projection_dim]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              batch_size = z1.shape[0]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      device = z1.device
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      # Normalize projections
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              z1 = F.normalize(z1, dim=1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      z2 = F.normalize(z2, dim=1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      # Concatenate projections
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              z = torch.cat([z1, z2], dim=0)  # [2*batch_size, projection_dim]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              # Compute similarity matrix
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      sim_matrix = torch.matmul(z, z.T) / self.temperature  # [2*batch_size, 2*batch_size]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      # Create labels for positive pairs
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              labels = torch.arange(2 * batch_size, device=device)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      labels[:batch_size] += batch_size
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              labels[batch_size:] -= batch_size
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              # Mask out self-similarities
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      mask = torch.eye(2 * batch_size, device=device, dtype=torch.bool)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              sim_matrix = sim_matrix.masked_fill(mask, float('-inf'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              # Compute loss
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      loss = F.cross_entropy(sim_matrix, labels)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return loss


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              class MRIDataset(Dataset):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  """Dataset class for 3D MRI data"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          def __init__(self, data_list: List[Dict[str, str]], transforms=None):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  self.data_list = data_list
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          self.transforms = transforms
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  def __len__(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return len(self.data_list)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  def __getitem__(self, idx):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          data = self.data_list[idx]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if self.transforms:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return self.transforms(data)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return data


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          def create_data_loaders(data_dir: str, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 batch_size: int = 8,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        num_workers: int = 4,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               cache_rate: float = 1.0) -> DataLoader:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   """Create data loaders for SimCLR training"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           # Example data list - replace with your actual data paths
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               data_list = [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       {"image": f"{data_dir}/patient_{i:03d}.nii.gz"} 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               for i in range(100)  # Replace with your actual data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               # Create augmentation pipeline
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   augmentations = SimCLRAugmentations()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           # Create dataset
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               dataset = CacheDataset(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       data=data_list,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               transform=augmentations,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       cache_rate=cache_rate,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               num_workers=num_workers
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       # Create data loader
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           dataloader = DataLoader(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   dataset,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           batch_size=batch_size,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   shuffle=True,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           num_workers=num_workers,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   pin_memory=True,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           drop_last=True
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   return dataloader


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   def train_simclr(model: SimCLRViT3D,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   dataloader: DataLoader,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   num_epochs: int = 100,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   lr: float = 1e-4,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   weight_decay: float = 1e-6,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   temperature: float = 0.07,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   device: str = 'cuda'):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       """Training loop for SimCLR"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               model = model.to(device)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   model.train()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           # Initialize optimizer and loss function
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               optimizer = torch.optim.AdamW(model.parameters(), lr=lr, weight_decay=weight_decay)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   criterion = NTXentLoss(temperature=temperature)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           # Learning rate scheduler
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               scheduler = torch.optim.lr_scheduler.CosineAnnealingLR(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       optimizer, T_max=num_epochs, eta_min=lr * 0.01
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       for epoch in range(num_epochs):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   total_loss = 0.0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           num_batches = 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           for batch_idx, (view1, view2) in enumerate(dataloader):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           view1 = view1.to(device)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       view2 = view2.to(device)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               # Forward pass
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           _, z1 = model(view1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       _, z2 = model(view2)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               # Compute loss
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           loss = criterion(z1, z2)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   # Backward pass
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               optimizer.zero_grad()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           loss.backward()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       optimizer.step()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               total_loss += loss.item()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           num_batches += 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   if batch_idx % 10 == 0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       print(f'Epoch [{epoch+1}/{num_epochs}], '
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             f'Batch [{batch_idx+1}/{len(dataloader)}], '
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   f'Loss: {loss.item():.4f}')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       # Update learning rate
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               scheduler.step()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               avg_loss = total_loss / num_batches
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       print(f'Epoch [{epoch+1}/{num_epochs}] completed. Average Loss: {avg_loss:.4f}')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       # Save checkpoint every 10 epochs
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if (epoch + 1) % 10 == 0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               torch.save({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   'epoch': epoch,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   'model_state_dict': model.state_dict(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   'optimizer_state_dict': optimizer.state_dict(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   'loss': avg_loss,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }, f'simclr_vit_checkpoint_epoch_{epoch+1}.pth')


# Example usage
if __name__ == "__main__":
        # Set device
            device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')
                print(f"Using device: {device}")
                    
                        # Initialize model
                            model = SimCLRViT3D(
                                    img_size=(96, 96, 96),
                                            patch_size=(16, 16, 16),
                                                    in_channels=1,
                                                            hidden_size=768,
                                                                    mlp_dim=3072,
                                                                            num_heads=12,
                                                                                    num_layers=12,
                                                                                            projection_dim=128
                                                                                                )
                                
                                    print(f"Model initialized with {sum(p.numel() for p in model.parameters())} parameters")
                                        
                                            # Create data loader (replace with your data directory)
                                                # dataloader = create_data_loaders(
                                                    #     data_dir="/path/to/your/mri/data",
                                                        #     batch_size=4,  # Adjust based on GPU memory
                                                            #     num_workers=4
                                                                # )
                                                    
                                                        # Train the model
                                                            # train_simclr(
                                                                #     model=model,
                                                                    #     dataloader=dataloader,
                                                                        #     num_epochs=100,
                                                                            #     lr=1e-4,
                                                                                #     weight_decay=1e-6,
                                                                                    #     device=device
                                                                                        # )
                                                                
                                                                    print("SimCLR implementation ready for training!")
